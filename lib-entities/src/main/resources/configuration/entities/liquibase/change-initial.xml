<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <!-- Quartz tables -->
    <include file="quartz-2-1-3/tables_hsqldb_blob.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_postgres.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_oracle.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_mysql_innodb.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_firebird.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_h2.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_sybase.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_derby.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_db2_v95.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_sqlServer.sql" relativeToChangelogFile="true"/>
    <include file="quartz-2-1-3/tables_informix.sql" relativeToChangelogFile="true"/>

    <!-- Qzerver tables -->
    <changeSet id="ddl_qzerver_tables" author="qzerver">
        <createTable tableName="qzerver_cluster_group">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_cluster_group"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(256)">
                <constraints nullable="false"/>
            </column>
            <column name="rolling_index" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_cluster_node">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_cluster_node"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="domain" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="order_index" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="active" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="cluster_group_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_job">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_job"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="VARCHAR(512)">
                <constraints nullable="true"/>
            </column>
            <column name="cron" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="enabled" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="standby" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="concurrent" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="limit_trials" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="limit_timeout" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="all_nodes" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="strategy" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="cluster_group_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="schedule_group_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_action_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_group">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_group"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_action">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_action"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="archived" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="definition" type="LONGBLOB">
                <constraints nullable="true"/>
            </column>
            <column name="created" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_execution">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_execution"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="cron" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="manual" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="fired" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="scheduled" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="started" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="finished" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
            <column name="status" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="timeout" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="cancelled" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="all_nodes" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="strategy" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="hostname" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_job_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_action_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_execution_node">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_execution_node"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="domain" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="localhost" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="order_index" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_execution_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="qzerver_schedule_execution_result">
            <column name="id" autoIncrement="true" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_qzerver_schedule_execution_result"/>
            </column>
            <column name="business_model" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_hi" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="business_id_lo" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="succeed" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
            <column name="started" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="finished" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>
            <column name="order_index" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="payload" type="LONGBLOB">
                <constraints nullable="true"/>
            </column>
            <column name="schedule_execution_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="schedule_execution_node_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <modifySql dbms="mysql">
            <append value=" engine innodb"/>
        </modifySql>
    </changeSet>

    <changeSet id="ddl_qzerver_constraints" author="qzerver">
        <addForeignKeyConstraint constraintName="fk_qzerver_cluster_node_ref_group"
                baseTableName="qzerver_cluster_node" baseColumnNames="cluster_group_id"
                referencedTableName="qzerver_cluster_group" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_job_ref_cluster"
                baseTableName="qzerver_schedule_job" baseColumnNames="cluster_group_id"
                referencedTableName="qzerver_cluster_group" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_job_ref_group"
                baseTableName="qzerver_schedule_job" baseColumnNames="schedule_group_id"
                referencedTableName="qzerver_schedule_group" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_job_ref_action"
                baseTableName="qzerver_schedule_job" baseColumnNames="schedule_action_id"
                referencedTableName="qzerver_schedule_action" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_execution_ref_job"
                baseTableName="qzerver_schedule_execution" baseColumnNames="schedule_job_id"
                referencedTableName="qzerver_schedule_job" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_execution_ref_action"
                baseTableName="qzerver_schedule_execution" baseColumnNames="schedule_action_id"
                referencedTableName="qzerver_schedule_action" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_execution_node_ref_execution"
                baseTableName="qzerver_schedule_execution_node" baseColumnNames="schedule_execution_id"
                referencedTableName="qzerver_schedule_execution" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_execution_result_ref_execution"
                baseTableName="qzerver_schedule_execution_result" baseColumnNames="schedule_execution_id"
                referencedTableName="qzerver_schedule_execution" referencedColumnNames="id"
                deleteCascade="true"/>
        <addForeignKeyConstraint constraintName="fk_qzerver_execution_result_ref_node"
                baseTableName="qzerver_schedule_execution_result" baseColumnNames="schedule_execution_node_id"
                referencedTableName="qzerver_schedule_execution_node" referencedColumnNames="id"
                deleteCascade="true"/>
    </changeSet>
    
    <changeSet id="ddl_qzerver_indexes" author="qzerver">
        <createIndex tableName="qzerver_schedule_execution" indexName="idx_qzerver_schedule_execution_started">
            <column name="started"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>